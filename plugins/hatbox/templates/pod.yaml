apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Chart.Name }}-{{ .Release.Name }}"
  labels:
    app: "{{ .Chart.Name }}-{{ .Release.Name }}"
spec:
  imagePullSecrets:
    - name: regcred
  restartPolicy: Always
  containers:
    - name: "{{ .Chart.Name }}"
      image: "{{ .Values.container.image }}"
      securityContext:
        runAsUser: 0
        privileged: false
      command:
        - "sh"
        - "-c"
      args:
        - "{{ .Values.container.command }}; sleep 36000"
      imagePullPolicy: Always
      env:
        - name: REPORT
          value: "{{ .Values.container.report }}"
        - name: PREFIX
          value: "{{ .Chart.Name }}-{{ .Release.Name }}"
        - name: MINIO_HOST
          valueFrom:
            configMapKeyRef:
              name: atop-globe-config
              key: minio_host
        - name: TYPE
          value: "{{ .Chart.Name }}"
        - name: FILES_SERVICE
          valueFrom:
            configMapKeyRef:
              name: atop-globe-config
              key: files_service_hosts
      volumeMounts:
        - name: config-cli
          readOnly: true
          mountPath: /atop/cli.py
          subPath: cli.py
        # - name: share
        #   mountPath: /report
        - name: data
          mountPath: /hatbox/data
        - name: cache
          mountPath: /hatbox/Log/logs
    - name: filebeat
      image: docker.elastic.co/beats/filebeat:7.17.10
      args:
        - "-e"
        - "-E"
        - "http.enabled=true"
      livenessProbe:
        exec:
          command:
            - sh
            - -c
            - |
              #!/usr/bin/env bash -e
              curl --fail 127.0.0.1:5066
        failureThreshold: 3
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
      readinessProbe:
        exec:
          command:
            - sh
            - -c
            - |
              #!/usr/bin/env bash -e
              filebeat test output
        failureThreshold: 3
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
      securityContext:
        runAsUser: 0
        privileged: false
      imagePullPolicy: IfNotPresent
      env:
        - name: ELASTICSEARCH_SERVICE_HOSTS
          valueFrom:
            configMapKeyRef:
              name: atop-globe-config
              key: elasticsearch_service_hosts
      volumeMounts:
        - name: config-filebeat
          readOnly: true
          mountPath: /usr/share/filebeat/filebeat.yml
          subPath: filebeat.yml
        - name: cache
          mountPath: /hatbox/Log/logs
  volumes:
    - name: config-filebeat
      configMap:
        name: "{{ .Chart.Name }}-{{ .Release.Name }}-filebeat"
        items:
          - key: filebeat.yml
            path: filebeat.yml
    - name: config-cli
      configMap:
        name: "{{ .Chart.Name }}-{{ .Release.Name }}-cli"
        items:
          - key: cli.py
            path: cli.py
    # - name: share
    #   persistentVolumeClaim:
    #     claimName: data-atop-reports
    - name: data
      persistentVolumeClaim:
        claimName: "{{ .Chart.Name }}-{{ .Release.Name }}"
    - name: cache
      emptyDir: {}
